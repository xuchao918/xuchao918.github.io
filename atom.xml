<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>起风了</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-04-30T14:55:47.400Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>XuChao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>如何删除Registry中kolla-ansible的镜像</title>
    <link href="http://yoursite.com/2018/04/30/%E5%A6%82%E4%BD%95%E5%88%A0%E9%99%A4Registry%E4%B8%ADkolla-ansible%E7%9A%84%E9%95%9C%E5%83%8F/"/>
    <id>http://yoursite.com/2018/04/30/如何删除Registry中kolla-ansible的镜像/</id>
    <published>2018-04-30T14:37:15.000Z</published>
    <updated>2018-04-30T14:55:47.400Z</updated>
    
    <content type="html"><![CDATA[<p>出于某些情况，如释放磁盘空间、旧镜像删除等原因，需要我们删除本地Registry仓库中的镜像。本篇文章，将讲解如何在OpenStack环境的kolla-ansible中，删除本地Registry中的镜像。</p><h2 id="1-Registry中的镜像管理"><a href="#1-Registry中的镜像管理" class="headerlink" title="1.Registry中的镜像管理"></a>1.Registry中的镜像管理</h2><h3 id="1-1-查看Registry仓库中现有的镜像："><a href="#1-1-查看Registry仓库中现有的镜像：" class="headerlink" title="1.1 查看Registry仓库中现有的镜像："></a>1.1 查看Registry仓库中现有的镜像：</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#  curl -XGET http:<span class="comment">//172.17.51.51:4000/v2/_catalog</span></span></span><br></pre></td></tr></table></figure><h3 id="1-2-查看Registry仓库中指定的镜像，如这里的centos-source-magnum-conductor"><a href="#1-2-查看Registry仓库中指定的镜像，如这里的centos-source-magnum-conductor" class="headerlink" title="1.2 查看Registry仓库中指定的镜像，如这里的centos-source-magnum-conductor"></a>1.2 查看Registry仓库中指定的镜像，如这里的centos-source-magnum-conductor</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># curl -XGET http:<span class="comment">//172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/tags/list</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">## <span class="number">2.</span>如何删除私有 registry 中的镜像</span><br><span class="line">### <span class="number">2.1</span> 首先，在默认情况下，docker registry 是不允许删除镜像的，需要在配置文件config.yml中启用。</span><br></pre></td></tr></table></figure><h1 id="vim-etc-docker-registry-config-yml"><a href="#vim-etc-docker-registry-config-yml" class="headerlink" title="vim /etc/docker/registry/config.yml"></a>vim /etc/docker/registry/config.yml</h1><p>version: 0.1<br>log:<br>  fields:<br>    service: registry<br>storage:<br>  cache:<br>    blobdescriptor: inmemory<br>  filesystem:<br>    rootdirectory: /var/lib/registry<br>  delete:<br>    enabled: true<br>http:<br>  addr: :5000<br>  headers:<br>    X-Content-Type-Options: [nosniff]<br>health:<br>  storagedriver:<br>    enabled: true<br>    interval: 10s<br>    threshold: 3<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="number">2.2</span> 修改后，需要重启registry容器</span><br></pre></td></tr></table></figure></p><h1 id="docker-restart-registry"><a href="#docker-restart-registry" class="headerlink" title="docker restart registry"></a>docker restart registry</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="number">2.3</span> 使用API接口 GET /v2/&lt;镜像名&gt;/manifests/&lt;tag&gt; 来取得要删除的镜像:Tag所对应的 digest。</span><br><span class="line">比如，要删除kolla/centos-source-magnum-conductor:queens镜像，那么取得 digest 的命令是：</span><br></pre></td></tr></table></figure><h1 id="curl-–header-“Accept-application-vnd-docker-distribution-manifest-v2-json”-I-X-HEAD-http-172-17-51-51-4000-v2-kolla-centos-source-magnum-conductor-manifests-queens"><a href="#curl-–header-“Accept-application-vnd-docker-distribution-manifest-v2-json”-I-X-HEAD-http-172-17-51-51-4000-v2-kolla-centos-source-magnum-conductor-manifests-queens" class="headerlink" title="curl –header “Accept: application/vnd.docker.distribution.manifest.v2+json” -I -X HEAD http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/queens"></a>curl –header “Accept: application/vnd.docker.distribution.manifest.v2+json” -I -X HEAD <a href="http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/queens" target="_blank" rel="noopener">http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/queens</a></h1><p>HTTP/1.1 200 OK<br>Content-Length: 8666<br>Content-Type: application/vnd.docker.distribution.manifest.v2+json<br>Docker-Content-Digest: sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868<br>Docker-Distribution-Api-Version: registry/2.0<br>Etag: “sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868”<br>X-Content-Type-Options: nosniff<br>Date: Sat, 28 Apr 2018 02:44:46 GMT<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="number">2.4</span> 得到 Docker-Content-Digest:</span><br></pre></td></tr></table></figure></p><p>sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="number">2.5</span> 然后调用API接口 DELETE /v2/&lt;镜像名&gt;/manifests/&lt;digest&gt; 来删除镜像。比如：</span><br></pre></td></tr></table></figure></p><h1 id="curl-I-X-DELETE-http-172-17-51-51-4000-v2-kolla-centos-source-magnum-conductor-manifests-sha256-e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868"><a href="#curl-I-X-DELETE-http-172-17-51-51-4000-v2-kolla-centos-source-magnum-conductor-manifests-sha256-e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868" class="headerlink" title="curl -I -X DELETE http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868"></a>curl -I -X DELETE <a href="http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868" target="_blank" rel="noopener">http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868</a></h1><p>HTTP/1.1 202 Accepted<br>Docker-Distribution-Api-Version: registry/2.0<br>X-Content-Type-Options: nosniff<br>Date: Sat, 28 Apr 2018 03:34:31 GMT<br>Content-Length: 0<br>Content-Type: text/plain; charset=utf-8<br><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">至此，镜像已从 <span class="keyword">registry</span> 中标记删除，外界访问 pull 不到了。但是 <span class="keyword">registry</span> 的本地空间并未释放，需要垃圾收集才会释放。</span><br></pre></td></tr></table></figure></p><h1 id="docker-exec-registry-bin-registry-garbage-collect-etc-docker-registry-config-yml"><a href="#docker-exec-registry-bin-registry-garbage-collect-etc-docker-registry-config-yml" class="headerlink" title="docker exec registry bin/registry garbage-collect /etc/docker/registry/config.yml"></a>docker exec registry bin/registry garbage-collect /etc/docker/registry/config.yml</h1><p><code>`</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;出于某些情况，如释放磁盘空间、旧镜像删除等原因，需要我们删除本地Registry仓库中的镜像。本篇文章，将讲解如何在OpenStack环境的kolla-ansible中，删除本地Registry中的镜像。&lt;/p&gt;
&lt;h2 id=&quot;1-Registry中的镜像管理&quot;&gt;&lt;a h
      
    
    </summary>
    
      <category term="docker" scheme="http://yoursite.com/categories/docker/"/>
    
    
      <category term="kolla" scheme="http://yoursite.com/tags/kolla/"/>
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
      <category term="OpenStack" scheme="http://yoursite.com/tags/OpenStack/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2018/04/26/hello-world/"/>
    <id>http://yoursite.com/2018/04/26/hello-world/</id>
    <published>2018-04-26T15:15:23.237Z</published>
    <updated>2018-04-26T15:15:23.238Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
</feed>
