<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>起风了</title>
  
  <subtitle>xuchao&#39;s blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-05-01T10:07:42.787Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>XuChao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>如何删除Registry中kolla-ansible的镜像</title>
    <link href="http://yoursite.com/2018/04/30/%E5%A6%82%E4%BD%95%E5%88%A0%E9%99%A4Registry%E4%B8%ADkolla-ansible%E7%9A%84%E9%95%9C%E5%83%8F/"/>
    <id>http://yoursite.com/2018/04/30/如何删除Registry中kolla-ansible的镜像/</id>
    <published>2018-04-30T15:16:19.000Z</published>
    <updated>2018-05-01T10:07:42.787Z</updated>
    
    <content type="html"><![CDATA[<p>出于某些情况，如释放磁盘空间、旧镜像删除等原因，需要我们删除本地Registry仓库中的镜像。本篇文章，将讲解如何在OpenStack环境的kolla-ansible中，删除本地Registry中的镜像。</p><h2 id="Registry中的镜像管理"><a href="#Registry中的镜像管理" class="headerlink" title="Registry中的镜像管理"></a>Registry中的镜像管理</h2><p>查看Registry仓库中现有的镜像：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#curl</span> -XGET http:<span class="comment">//172.17.51.51:4000/v2/_catalog</span></span><br></pre></td></tr></table></figure></p><p>查看Registry仓库中指定的镜像，如这里的centos-source-magnum-conductor。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#curl</span> -XGET http:<span class="comment">//172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/tags/list</span></span><br></pre></td></tr></table></figure></p><h2 id="如何删除私有-registry-中的镜像"><a href="#如何删除私有-registry-中的镜像" class="headerlink" title="如何删除私有 registry 中的镜像"></a>如何删除私有 registry 中的镜像</h2><p>首先，在默认情况下，docker registry 是不允许删除镜像的，需要在配置文件config.yml中启用。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim /etc/docker/registry/config.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line"><span class="attr">  filesystem:</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">/var/lib/registry</span></span><br><span class="line"><span class="attr">  delete:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line"><span class="attr">  addr:</span> <span class="string">:5000</span></span><br><span class="line"><span class="attr">  headers:</span></span><br><span class="line"><span class="attr">    X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line"><span class="attr">  storagedriver:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">    threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure></p><p>修改后，需要重启registry容器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">docker restart registry</span></span><br></pre></td></tr></table></figure></p><p>使用API接口 GET /v2/&lt;镜像名&gt;/manifests/<tag> 来取得要删除的镜像:Tag所对应的 digest。比如，要删除kolla/centos-source-magnum-conductor:queens镜像，那么取得 digest 的命令是：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#curl</span> --<span class="selector-tag">header</span> <span class="string">"Accept: application/vnd.docker.distribution.manifest.v2+json"</span> -I -X HEAD http:<span class="comment">//172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/queens</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Length: <span class="number">8666</span></span><br><span class="line">Content-Type: application/vnd<span class="selector-class">.docker</span><span class="selector-class">.distribution</span><span class="selector-class">.manifest</span><span class="selector-class">.v2</span>+json</span><br><span class="line">Docker-Content-Digest: sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868</span><br><span class="line">Docker-Distribution-Api-Version: registry/<span class="number">2.0</span></span><br><span class="line">Etag: <span class="string">"sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868"</span></span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">Date: Sat, <span class="number">28</span> Apr <span class="number">2018</span> <span class="number">02</span>:<span class="number">44</span>:<span class="number">46</span> GMT</span><br></pre></td></tr></table></figure></tag></p><p>得到 Docker-Content-Digest:<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha<span class="number">256</span>:e<span class="number">94</span><span class="keyword">c</span><span class="number">4</span>d<span class="number">08520</span>a<span class="number">7</span>f<span class="number">77</span>cbfa<span class="number">0</span><span class="keyword">c</span><span class="number">2</span>d<span class="number">314</span>bc<span class="number">9281</span>d<span class="number">07874</span>b<span class="number">8</span><span class="keyword">c</span><span class="number">7</span>d<span class="number">9337</span>ad<span class="number">5</span>f<span class="number">541832</span>f<span class="number">7</span>d<span class="number">868</span></span><br></pre></td></tr></table></figure></p><p>然后调用API接口 DELETE /v2/&lt;镜像名&gt;/manifests/<digest> 来删除镜像。比如：<br><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#curl -I -X DELETE http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868</span></span><br><span class="line"><span class="attribute">HTTP/1.1 202 Accepted</span></span><br><span class="line"><span class="attribute">Docker-Distribution-Api-Version</span>: registry/2.0</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span>: nosniff</span><br><span class="line"><span class="attribute">Date</span>: Sat, 28 Apr 2018 03:34:31 GMT</span><br><span class="line"><span class="attribute">Content-Length</span>: 0</span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain; charset=utf-8</span><br></pre></td></tr></table></figure></digest></p><p>至此，镜像已从 registry 中标记删除，外界访问 pull 不到了。但是 registry 的本地空间并未释放，需要垃圾收集才会释放。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">docker <span class="built_in">exec</span> registry bin/registry garbage-collect /etc/docker/registry/config.yml</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;出于某些情况，如释放磁盘空间、旧镜像删除等原因，需要我们删除本地Registry仓库中的镜像。本篇文章，将讲解如何在OpenStack环境的kolla-ansible中，删除本地Registry中的镜像。&lt;/p&gt;
&lt;h2 id=&quot;Registry中的镜像管理&quot;&gt;&lt;a hre
      
    
    </summary>
    
      <category term="docker" scheme="http://yoursite.com/categories/docker/"/>
    
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
      <category term="kolla" scheme="http://yoursite.com/tags/kolla/"/>
    
      <category term="openstack" scheme="http://yoursite.com/tags/openstack/"/>
    
  </entry>
  
</feed>
