<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[如何删除Registry中kolla-ansible的镜像]]></title>
    <url>%2F2018%2F04%2F30%2F%E5%A6%82%E4%BD%95%E5%88%A0%E9%99%A4Registry%E4%B8%ADkolla-ansible%E7%9A%84%E9%95%9C%E5%83%8F%2F</url>
    <content type="text"><![CDATA[出于某些情况，如释放磁盘空间、旧镜像删除等原因，需要我们删除本地Registry仓库中的镜像。本篇文章，将讲解如何在OpenStack环境的kolla-ansible中，删除本地Registry中的镜像。 Registry中的镜像管理查看Registry仓库中现有的镜像：1#curl -XGET http://172.17.51.51:4000/v2/_catalog 查看Registry仓库中指定的镜像，如这里的centos-source-magnum-conductor。123456#curl -XGET http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/tags/list``` ## 如何删除私有 registry 中的镜像首先，在默认情况下，docker registry 是不允许删除镜像的，需要在配置文件config.yml中启用。 #vim /etc/docker/registry/config.ymlversion: 0.1log: fields: service: registrystorage: cache: blobdescriptor: inmemory filesystem: rootdirectory: /var/lib/registry delete: enabled: truehttp: addr: :5000 headers: X-Content-Type-Options: [nosniff]health: storagedriver: enabled: true interval: 10s threshold: 312修改后，需要重启registry容器 #docker restart registry123使用API接口 GET /v2/&lt;镜像名&gt;/manifests/&lt;tag&gt; 来取得要删除的镜像:Tag所对应的 digest。比如，要删除kolla/centos-source-magnum-conductor:queens镜像，那么取得 digest 的命令是： #curl –header “Accept: application/vnd.docker.distribution.manifest.v2+json” -I -X HEAD http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/queensHTTP/1.1 200 OKContent-Length: 8666Content-Type: application/vnd.docker.distribution.manifest.v2+jsonDocker-Content-Digest: sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868Docker-Distribution-Api-Version: registry/2.0Etag: “sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868”X-Content-Type-Options: nosniffDate: Sat, 28 Apr 2018 02:44:46 GMT12得到 Docker-Content-Digest: sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d86812然后调用API接口 DELETE /v2/&lt;镜像名&gt;/manifests/&lt;digest&gt; 来删除镜像。比如： #curl -I -X DELETE http://172.17.51.51:4000/v2/kolla/centos-source-magnum-conductor/manifests/sha256:e94c4d08520a7f77cbfa0c2d314bc9281d07874b8c7d9337ad5f541832f7d868HTTP/1.1 202 AcceptedDocker-Distribution-Api-Version: registry/2.0X-Content-Type-Options: nosniffDate: Sat, 28 Apr 2018 03:34:31 GMTContent-Length: 0Content-Type: text/plain; charset=utf-812至此，镜像已从 registry 中标记删除，外界访问 pull 不到了。但是 registry 的本地空间并未释放，需要垃圾收集才会释放。 #docker exec registry bin/registry garbage-collect /etc/docker/registry/config.yml`]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>kolla</tag>
        <tag>openstack</tag>
      </tags>
  </entry>
</search>
